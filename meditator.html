<!DOCTYPE html>
<html>

    <head>
        <title>Meditator /// Huizi's toolbox</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" type="text/css" href="styles/style.css">
      <link rel="icon" href="icon.png" type="image/gif" sizes="16x16">
      <meta name="description" content="A collection of web toys made with a taoist orientation: i-ching, meditation tracker, etc"/>
      <meta name="keywords" content="taoism,i-ching,i ching, iching, meditation, buddhism, buddism, mindfulness">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132762032-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132762032-3');
</script>



<!----------------->
      <style>
        .headerr h1{
          text-shadow: 3px 2px 4px darkorchid;
        }
        body{
          background:url(img/mediback.jpg) no-repeat fixed;
         background-size: cover;
        background-position: center center;
        }
        
        .testooo{
          background: rgba(220, 210, 220, 0.4);
          display: inline-block;
        }
        
        button{
      background-color: #A9CCE3;
      color:white;
      width:200px; 
      height:70px;
      margin:0px
      }
      button:hover {
          background-color: black;
          color:gold;
      }
      .contbot button {
      width:150px;
        height:30px;
        
      }

    .contbot #displaynumME {
      width:100px;

      background-color:#D2B4DE;
    }

    button:disabled{
      color:gray;
    }
    .contbot{
		margin: 0px 5px;
	}
		
    #paguer {
		width:399px;
		background-color: #58D68D;
		height:50px;
	}
	
	
    @media screen and (max-width: 800px) {
    .contbot button {
      width:40%;
      height:30px;
     }
		#paguer {
		width:99%;
	}
      .contbot #displaynumME {
       width:19%;
        background-color:orange;
      }
    }
        
        
      </style>
      <script>
      $(document).ready(function () {
          $("#displaynumME").text(indLS +1);
          if (indLS<0) $('.antME').prop('disabled', true);

        //alert(indLS);

          $(".antME").click(function(){
            //alert("culo");
            indLS--;

            $("#displaynumME").text(indLS +1);

            let cajon = getLS();

            calcularLS(cajon[indLS][0],cajon[indLS][1] )

            validarBotones(cajon);

          });

          $(".sigME").click(function(){

            indLS++;

            $("#displaynumME").text(indLS +1);


            let cajon = getLS();
            
            calcularLS(cajon[indLS][0],cajon[indLS][1] )


            validarBotones(cajon);

          });

      
      });
      </script>
    </head>
    <body onkeydown="inhalacion(event)" onkeyup="exhalacion()" >
      
      <div class="headerr">
       <div class="headcontain">
       <img src="img/medihead.jpg"/>
      <!--<img src="https://cdn.glitch.com/a5770f3f-8039-4fd7-96d4-f99b40d52f79%2Fmedi.jpg?1558431136138"/>-->
       <h1>
         Anapanasati /// Huizi's toolbox 
       </h1>  
       </div>
     </div>
 <div class="navcont">
       
     
      <nav class="menuD">
	    <!--<img  src="icon.png"/>-->
	    <img src="img/menupakua.png"><img class="borger" src="img/menuborger.png">
		  <!--<a class="menuI" target="myIframe" href="https://zarlanga.github.io/yinyang/public_html/" >Yin-Yang</a>
      <a class="menuI" target="myIframe" href="https://zarlanga.github.io/i-ching/public_html/" >I-Ching</a>
		  <a class="menuI" target="myIframe" href="https://zarlanga.github.io/Meditator/public_html/medi.html" >Meditator</a>
		  <a class="menuI" target="myIframe" href="https://zarlanga.github.io/GraficadorHTML/public_html/" >Graficador</a>-->
        <br>
        <a class="menuI"  href="index.html" >Home</a>
        <a class="menuI"  href="yinyang.html" >Yin-Yang</a>
        <a class="menuI"  href="i-ching.html" >I-Ching</a>
        <a class="menuI"  href="meditator.html" >Anapanasati</a>
		<a class="menuI"  href="ddj.html" >道德經</a>
        
		
      </nav>
      </div>
      <br>
	  
      <div >
		
        <div class="contbot"  >
		<button id="paguer" onclick="calcular()" >COMENZAR</button><br>  
          <button class="antME" >Anterior</button><button id="displaynumME">sasa</button><button class="sigME" disabled="true">Siguiente</button><br>  
        </div>
        <canvas onmousedown="inhalacion(event)" onmouseup="exhalacion()" ontouchstart="inhalacion(event)" ontouchend="exhalacion()" id="myCanvas" width="400" height="400"  style="border:1px solid;background-color: coral; float:left; margin:5px "></canvas>
      </div>
        <div class="testooo">
          
      
        <p> <!--<strong>**** EN CONSTRUCCION****</strong> <br>-->Presione cualquier tecla o haga click sobre el cuadro al inhalar y sueltela al exhalar.<br><strong>En anapanasati se intenta no controlar la respiracion, solamente observarla</strong> <br> Cuando termine haga click en calcular </p>
        
        <p id="resultado"></p>
          </div>
        <script type="text/javascript">
          
            /* features
             * ver que limite minimo y maximo poner para la IN/EX
             * -graficar la duracion de la respiracion? respiracion mas larga y mas corta?
             * -promedios de duracion de respiraciones y/o respiraciones por minutos (dividiendo la sesion en x partes?)
             -linea que baje y suba con la respiracion? (maomeno, mejorable)
             -respiraciones por minuto (cada cuanto calcularlas? como mostrarlas?) (ponele que esta)
             -comparacion de inhalacion y exhalacion (ponele que esta)
             -tiempo total! (listo)
             -duracion de cada respiracion (listo)
             -ver que onda el redondeo con las horas minutos y segundos (listo)
             
             
             
             
             
             
             
             */
            /* recuerdos var i = 0;
             var t0= Date.now(); 
             
             i++;
             alert(i +" //  "+  (Date.now() - t0) );  (en calcular)
             
             */
            var indLS = getLS().length -1;
            var tiemposIN = [];
            var tiemposEX = [];
			var power = false;
            var dale = true;
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            function graficarEX() {
                ctx.beginPath();
                ctx.fillStyle = "#AED6F1";
                ctx.fillRect(0, c.height / 2, c.width, c.height / 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.fillStyle = "#5499C7";
                ctx.fillRect(0, 0, c.width, c.height / 2);
                ctx.stroke();
            }
            function graficarIN() {
                ctx.beginPath();
                ctx.fillStyle = "#AED6F1";
                ctx.fillRect(0, 0, c.width, c.height / 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.fillStyle = "#5499C7";
                ctx.fillRect(0, c.height / 2, c.width, c.height / 2);
                ctx.stroke();
            }
            function limpiarGrafico(colo) {
                ctx.beginPath();
                //ctx.lineWidth = "6";
                //ctx.strokeStyle = "coral";
                ctx.fillStyle = colo;
                ctx.fillRect(0, 0, c.width, c.height);
                //ctx.rect(0, 0, 400, 200);
                //ctx.rect(0, 200, 400, 200);
                ctx.stroke();
            }
            function graficarArray(arr, int) {
                dist = c.width / (arr.length - 1);
                if (int == 1) {//para graficar rpm
                    var offset;
                    pmax = Math.max.apply(null, arr) + 2;
                    pmin = Math.min.apply(null, arr) - 2;
                    offset = 1500 * 1500 / (pmax - pmin); // para que no sea siempre igual la amplitud en el grafico
                    pmax += offset;
                    pmin -= offset;
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "red";
                } else {
                    pmax = Math.max.apply(null, arr) + 2;
                    pmin = Math.min.apply(null, arr) - 2;
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = "white";
                }
                //alert("maximo="+pmax);
                //alert("minimo="+pmin);
                ctx.beginPath();
                for (var i = 0; i < arr.length - 1; i++) {
                    ctx.moveTo(dist * i, sacarY(pmin, pmax, arr[i]));
                    ctx.lineTo(dist * (i + 1), sacarY(pmin, pmax, arr[i + 1]));
                    ctx.stroke();
                }
            }
            function sacarY(min, max, y) {
                distY = c.height / (max - min);
                yfin = c.height - (y - min) * distY;
                return yfin;
            }
            function calcular() {
                //dale=false;
				if (!power) {
					power=true;
					document.getElementById("paguer").innerHTML = 'TERMINAR Y CALCULAR';
					document.getElementById("paguer").style.backgroundColor = "#CB4335";
					limpiarGrafico("#58D68D");
				} else {
					power=false;
					document.getElementById("paguer").innerHTML = 'COMENZAR'
					document.getElementById("paguer").style.backgroundColor = "#58D68D";
					var testo = "";
					var rpm = []; //array para guardar las respiraciones por minuto (eventualmente sacar promedios parciales?)
					var rpmAC = 0; // acumulador para calcular el promedio
					var tr = []; // array para duracion de respiraciones
					var tInAc = 0; //acumulador tiempo de inhalacion
					var tExAc = 0; // acumulador tiempo exhalacion
					var tTotal; // array con cantidad de horas en pos [0], min en [1], seg en [2]
					var proporcionINEX = [];
					dataTest = "";
					limpiarGrafico("#717D7E");
					for (var p = 0; p < tiemposIN.length - 1; p++) {
						tx = (tiemposIN[p + 1] - tiemposIN[p]);
						tIn = tiemposEX[p] - tiemposIN[p];
						tEx = tiemposIN[p + 1] - tiemposEX[p];
						tInAc += tIn;
						tExAc += tEx;
						proporcionINEX[proporcionINEX.length] = tIn / (tIn + tEx);
						tr[tr.length] = tx;
						rpm[rpm.length] = 60000 / tx;
						//rpm[rpm.length] = (60000 / tx).toFixed(2);
						rpmAC += rpm[p];
						dataTest += tIn + "IN///" + tEx + "EX||||||||";
						dataTest += tx / 1000 + "segundos////" + rpm[p].toFixed(2) + "rpm  <br>";
					}
					graficarArray(rpm, 0);
					
				  guardarLS(tiemposIN, tiemposEX);
				  indLS = getLS().length -1
				  $("#displaynumME").text(indLS +1);
				  validarBotones(getLS());
				  
				  //graficarArray(tr, 1);
					//graficarArray(proporcionINEX, 0);
					tTotal = calcularHMS(tiemposIN[tiemposIN.length - 1] - tiemposIN[0]); //parametro es la diferencia de tiempo en milisegundos desde el inicio hasta el calcular
					testo += "<br>Respiraciones por minuto promedio: " + (rpmAC / (tiemposIN.length - 1)).toFixed(2) + "<br>";
					testo += "<br> Pico maximo: " + (Math.max.apply(null, rpm)).toFixed(2) + "rpm<br>";
					testo += "<br> Pico minimo: " + (Math.min.apply(null, rpm)).toFixed(2) + "rpm<br>";
					testo += "<br> Amplitud: " + (Math.max.apply(null, tr) - Math.min.apply(null, tr)) + "milisegundos <br>";
					testo += "<br> Proporcion In/Ex: " + Math.floor((tInAc / (tExAc + tInAc)) * 100) + "% in/" + Math.floor((tExAc / (tExAc + tInAc)) * 100) + "% ex<br>";
					//testo += "<br> Proporcion In/Ex: " +( (tInAc > tExAc) ? (tInAc/tExAc).toFixed(2) +  " Inhalacion<br>" : (tExAc/tInAc).toFixed(2) + "Exhalacion<br>" );
					testo += "<br>Total respiraciones: " + (tiemposIN.length - 1) + "<br>";
					testo += "<br>Tiempo total: " + tTotal[0] + " horas, " + tTotal[1] + " min,  " + tTotal[2] + "seg<br>";
					//testo += calcularTTotal();
					document.getElementById("resultado").innerHTML = testo;
					//document.getElementById("resultado").innerHTML += "<br>" + dataTest;
					tiemposIN = [];
					tiemposEX = [];
				}
            }
            function calcularHMS(tMS) {
                //ahre que podria haber usado la funcion tal como estaba antes
                //var tMS; // tiempo en milisegundos
                //var tHoras;
                //var tMin;
                //ar tSeg;
                var Tresultado = [];
                //tMS = (tiemposIN[tiemposIN.length - 1] - tiemposIN[0]);
                Tresultado[0] = Math.floor(tMS / 3600000);
                tMS -= Tresultado[0] * 3600000;
                Tresultado[1] = Math.floor(tMS / 60000);
                tMS -= Tresultado[1] * 60000;
                Tresultado[2] = (tMS / 1000).toFixed(2);
                return Tresultado;
                //return "<br>Tiempo total: " + tHoras + " horas, " + tMin + " min " + tSeg + "seg<br>";
            }
            function exhalacion() {
				if (power) {
					dale = true;
					tiemposEX[tiemposEX.length] = Date.now();
					graficarEX();
				}
            }
            function inhalacion(e) {
                if (dale && power) {
                    tiemposIN[tiemposIN.length] = Date.now();
                    graficarIN();
                    dale = false;
                    actualizarRPMActual();
                }
            }
            function actualizarRPMActual() {
                if (tiemposIN.length > 1) {
                    var rpmNOW = (tiemposIN[ tiemposIN.length - 1] - tiemposIN[tiemposIN.length - 2]);
                    var tTranscurrido = calcularHMS(tiemposIN[tiemposIN.length - 1] - tiemposIN[0]);
                    var testo = "";
                    testo += "<big><big><big><big><big>RPM=" + (60000 / rpmNOW).toFixed(2) + "<br>";
                    testo += "<br>" + tTranscurrido[0] + " horas, " + tTranscurrido[1] + " min, " + tTranscurrido[2] + "seg<br>";
                    testo += "</big></big></big></big></big>";
                    document.getElementById("resultado").innerHTML = testo;
                }
            }
          
          function calcularLS(arrIN, arrEX) {
                //dale=false;
                var testo = "";
                var rpm = []; //array para guardar las respiraciones por minuto (eventualmente sacar promedios parciales?)
                var rpmAC = 0; // acumulador para calcular el promedio
                var tr = []; // array para duracion de respiraciones
                var tInAc = 0; //acumulador tiempo de inhalacion
                var tExAc = 0; // acumulador tiempo exhalacion
                var tTotal; // array con cantidad de horas en pos [0], min en [1], seg en [2]
                var proporcionINEX = [];
                dataTest = "";
                limpiarGrafico();
                for (var p = 0; p < arrIN.length - 1; p++) {
                    tx = (arrIN[p + 1] - arrIN[p]);
                    tIn = arrEX[p] - arrIN[p];
                    tEx = arrIN[p + 1] - arrEX[p];
                    tInAc += tIn;
                    tExAc += tEx;
                    proporcionINEX[proporcionINEX.length] = tIn / (tIn + tEx);
                    tr[tr.length] = tx;
                    rpm[rpm.length] = 60000 / tx;
                    //rpm[rpm.length] = (60000 / tx).toFixed(2);
                    rpmAC += rpm[p];
                    dataTest += tIn + "IN///" + tEx + "EX||||||||";
                    dataTest += tx / 1000 + "segundos////" + rpm[p].toFixed(2) + "rpm  <br>";
                }
                graficarArray(rpm, 0);
                
              
              
              //graficarArray(tr, 1);
                //graficarArray(proporcionINEX, 0);
                tTotal = calcularHMS(arrIN[arrIN.length - 1] - arrIN[0]); //parametro es la diferencia de tiempo en milisegundos desde el inicio hasta el calcular
                testo += "<br>Respiraciones por minuto promedio: " + (rpmAC / (arrIN.length - 1)).toFixed(2) + "<br>";
                testo += "<br> Pico maximo: " + (Math.max.apply(null, rpm)).toFixed(2) + "rpm<br>";
                testo += "<br> Pico minimo: " + (Math.min.apply(null, rpm)).toFixed(2) + "rpm<br>";
                testo += "<br> Amplitud: " + (Math.max.apply(null, tr) - Math.min.apply(null, tr)) + "milisegundos <br>";
                testo += "<br> Proporcion In/Ex: " + Math.floor((tInAc / (tExAc + tInAc)) * 100) + "% in/" + Math.floor((tExAc / (tExAc + tInAc)) * 100) + "% ex<br>";
                //testo += "<br> Proporcion In/Ex: " +( (tInAc > tExAc) ? (tInAc/tExAc).toFixed(2) +  " Inhalacion<br>" : (tExAc/tInAc).toFixed(2) + "Exhalacion<br>" );
                testo += "<br>Total respiraciones: " + (arrIN.length - 1) + "<br>";
                testo += "<br>Tiempo total: " + tTotal[0] + " horas, " + tTotal[1] + " min,  " + tTotal[2] + "seg<br>";
                //testo += calcularTTotal();
                document.getElementById("resultado").innerHTML = testo;
                document.getElementById("resultado").innerHTML += "<br>" + dataTest;
                arrIN = [];
                arrEX = [];
            }
          
          
         function guardarLS(arrIN, arrEX){
              if (localStorage.getItem("arrayME") == null) {
                localStorage.setItem("arrayME","[]");
              }
              let cajon = JSON.parse(localStorage.getItem("arrayME"));
              cajon.push([arrIN, arrEX]);
              localStorage.setItem("arrayME", JSON.stringify(cajon) );
            }

         function getLS() {
            if (localStorage.getItem("arrayME") != null) {
              let cajon = JSON.parse(localStorage.getItem("arrayME"));
              return cajon;
            } else{
              return [];
              }
          }
          function validarBotones(arr){

            if (indLS < 1) {
              $('.antME').prop('disabled', true);
            } else {
              $('.antME').prop('disabled', false);
            }

            if(indLS >= arr.length -1) {
              
              $('.sigME').prop('disabled',true);
            } else {
              
              $('.sigME').prop('disabled',false);
            }


        }
          
          
          
        </script>
    </body>
</html>
